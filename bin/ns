#!/bin/sh

set -e

if [ -z "$1" ]; then
    echo "Usage: $(basename $0) SSH_HOST"
    exit 1
fi
remote_host="$1"

if ! command -v nvim >/dev/null; then
    echo "nvim is not installed."
    exit 1
fi

local_sock="/tmp/nvim-${remote_host}-$$.sock"

ssh_exec="ssh $remote_host -S /tmp/nvimssh-${remote_host}-$$.sock"

$ssh_exec -M -f -N
trap "$ssh_exec -O exit 2>/dev/null ; rm $local_sock" EXIT

remote_sock="/tmp/nvim-${remote_host}-$($ssh_exec id -u).sock"

port_map="${local_sock}:${remote_sock}"
if ! $ssh_exec "test -S $remote_sock" >/dev/null; then
    nvim_exec="/usr/bin/env fish -c \"nvim_scratch --listen $remote_sock --headless\""
    $ssh_exec "bash -c 'NVIM_SOCK=$remote_sock nohup $nvim_exec >/dev/null 2>&1 &'"
    $ssh_exec -f -N -L "$port_map"
    until nvim --server "$local_sock" --remote-send "<esc>" >/dev/null 2>&1; do
        sleep 0.1
    done
else
    $ssh_exec -f -N -L "$port_map"
fi


nvim --server "$local_sock" --remote-ui
