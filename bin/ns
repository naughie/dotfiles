#!/bin/sh

set -e

if [ -z "$1" ]; then
    echo "Usage: $(basename $0) SSH_HOST"
    exit 1
fi
remote_host="$1"

if ! command -v nvim >/dev/null; then
    echo "nvim is not installed."
    exit 1
fi

local_sock="/run/user/$(id -u)/nvim-${remote_host}-$$.sock"

ssh_exec="ssh $remote_host -S /run/user/$(id -u)/nvimssh-${remote_host}-$$.sock"

$ssh_exec -M -f -N
trap "$ssh_exec -O exit 2>/dev/null ; rm $local_sock" EXIT

remote_uid="$($ssh_exec id -u)"
remote_sock="/run/user/${remote_uid}/nvim-${remote_host}-${remote_uid}.sock"

port_map="${local_sock}:${remote_sock}"

socket_exists="$($ssh_exec ss -Hlx src $remote_sock)"
if test -z "$socket_exists"; then
    nvim_exec="nvim --listen $remote_sock --headless"
    $ssh_exec "/bin/sh -c 'NVIM_SOCK=$remote_sock nohup $nvim_exec >/dev/null 2>&1 &'"
    $ssh_exec -f -N -L "$port_map"
    until nvim --server "$local_sock" --remote-send "<esc>" >/dev/null 2>&1; do
        sleep 0.1
    done
else
    $ssh_exec -f -N -L "$port_map"
fi


nvim --server "$local_sock" --remote-ui
